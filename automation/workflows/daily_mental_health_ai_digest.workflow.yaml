workflows:
  - id: daily_mental_health_ai_digest
    name: "Daily Mental Health + AI Breakthroughs Digest"
    schedule:
      type: cron
      expression: "0 7 * * *"
      timezone: "America/New_York"

    steps:
      - id: fetch_sources
        type: fetch
        params:
          sources:
            # --- PSYCHOLOGY / MENTAL HEALTH ---
            - id: psypost
              type: rss
              url: "https://www.psypost.org/feed"
              tags: ["psychology", "mental-health", "research"]

            - id: sciencedaily_psychology
              type: rss
              url: "https://www.sciencedaily.com/rss/mind_brain/psychology.xml"
              tags: ["psychology", "mental-health", "research"]

            - id: neuroscience_news
              type: rss
              url: "https://neurosciencenews.com/feed/"
              tags: ["neuroscience", "mental-health", "brain"]

            - id: apa_psycport
              type: html
              url: "https://www.apa.org/news/psycport"
              selector: "article, .news-item"
              tags: ["psychology", "apa", "news"]

            - id: aps_news
              type: html
              url: "https://www.psychologicalscience.org/news/releases"
              selector: "article, .post"
              tags: ["psychology", "aps", "research"]

            - id: nature_psychology
              type: rss
              url: "https://www.nature.com/subjects/psychology.rss"
              tags: ["psychology", "research", "journal"]

            # --- AI / ML BREAKTHROUGHS ---
            - id: openai_blog
              type: rss
              url: "https://openai.com/news/rss.xml"
              tags: ["ai", "openai"]

            - id: deepmind_blog
              type: rss
              url: "https://deepmind.google/discover/rss/"
              tags: ["ai", "deepmind"]

            - id: meta_ai
              type: rss
              url: "https://about.fb.com/news/feed/"
              tags: ["ai", "meta", "industry"]

            - id: huggingface_blog
              type: rss
              url: "https://huggingface.co/blog/feed.xml"
              tags: ["ai", "huggingface"]

            - id: mit_tech_review_ai
              type: rss
              url: "https://www.technologyreview.com/topic/artificial-intelligence/feed/"
              tags: ["ai", "news"]

            - id: ars_technica_ai
              type: rss
              url: "https://feeds.arstechnica.com/arstechnica/technology-lab"
              tags: ["ai", "news"]

      - id: normalize
        type: transform
        params:
          operations:
            - op: clean_html
            - op: strip_tracking_params_from_urls
            - op: normalize_whitespace
            - op: ensure_fields
              fields: ["title", "url", "summary", "published_at", "source_id", "content"]

      - id: filter_recent
        type: filter
        params:
          where:
            field: "published_at"
            op: "gte"
            value: "now-48h"

      - id: dedupe
        type: deduplicate
        params:
          keys: ["url"]
          fuzzy:
            field: "title"
            similarity_threshold: 0.85

      - id: classify_topic
        type: llm
        params:
          model: "gpt-5.1-mini"
          input_template: |
            Classify this article into one or more of:
            - mental_health
            - psychology
            - neuroscience
            - ai_research
            - ai_product
            - other

            Return JSON with:
            { "primary_topic": "...", "secondary_topics": ["...", "..."] }

            TITLE: {{title}}
            SOURCE: {{source_id}}
            SUMMARY: {{summary}}
            CONTENT: {{content | truncate(2000)}}
          output_mapping:
            primary_topic: "primary_topic"
            secondary_topics: "secondary_topics"

      - id: rank_items
        type: rank
        params:
          score_formula: |
            score = freshness_score(published_at) * 0.4
                  + source_authority_score(source_id) * 0.4
                  + length_score(summary) * 0.2
          limit: 20

      - id: summarize_articles
        type: llm
        params:
          model: "gpt-5.1-mini"
          batch: true
          input_template: |
            You are writing a sharp, founder-friendly daily digest.
            Summarize this article in 2â€“3 sentences, focusing on:
            - the concrete finding or breakthrough
            - why it matters for real people or practitioners
            - any limitations or caveats

            Return JSON:
            { "short_headline": "...", "summary": "...", "one_sentence_takeaway": "...", "tags": ["...", "..."] }

            TITLE: {{title}}
            SOURCE: {{source_id}}
            URL: {{url}}
            PUBLISHED_AT: {{published_at}}
            CONTENT: {{content | truncate(3500)}}
          output_mapping:
            short_headline: "digest_headline"
            summary: "digest_summary"
            one_sentence_takeaway: "digest_takeaway"
            tags: "digest_tags"

      - id: generate_perspective
        type: llm
        params:
          model: "gpt-5.1"
          group_by: "primary_topic"
          input_template: |
            You are Scott, an AI-first founder who cares deeply about mental health, behavior change, and practical impact.

            You write a daily digest that connects psychology + mental health research with AI breakthroughs.

            Given these articles and takeaways, write 120â€“200 words that:
            - Find the thread between them.
            - Explain why they matter for practitioners, builders, and curious humans.
            - Suggest 1â€“2 tiny things the reader could try today.
            - Stay grounded, non-hypey, and human.

            Output plain Markdown, no emojis.

            Topic bucket: {{primary_topic}}

            ARTICLES:
            {{#each items}}
            - TITLE: {{digest_headline}}
              TAKEAWAY: {{digest_takeaway}}
              SOURCE: {{source_id}}
              URL: {{url}}
            {{/each}}
          output_field: "topic_commentary"

      - id: build_newsletter
        type: template
        params:
          format: markdown
          template: |
            # Daily Brain & Machine Digest ðŸ§ ðŸ¤–
            _A daily bridge between mental health, psychology, and AI breakthroughs._

            Date: {{ now | date("MMMM D, YYYY") }}

            ---

            ## ðŸ§  Mental Health & Psychology

            {{#each items where primary_topic in ["mental_health", "psychology", "neuroscience"]}}
            ### {{digest_headline}}
            Source: {{source_id}}
            Link: {{url}}

            {{digest_summary}}

            _Takeaway:_ {{digest_takeaway}}

            ---
            {{/each}}

            {{ topic_commentary["mental_health"] ?? topic_commentary["psychology"] ?? "" }}

            ---

            ## ðŸ¤– AI & Machine Intelligence

            {{#each items where primary_topic in ["ai_research", "ai_product"]}}
            ### {{digest_headline}}
            Source: {{source_id}}
            Link: {{url}}

            {{digest_summary}}

            _Takeaway:_ {{digest_takeaway}}

            ---
            {{/each}}

            {{ topic_commentary["ai_research"] ?? topic_commentary["ai_product"] ?? "" }}

            ---

            ## ðŸ§© Putting It Together

            {{#llm "gpt-5.1"}}
            You are Scott, writing a closing section for your daily digest tying together mental health and AI.

            Todayâ€™s psychology/mental-health highlights:
            {{#each items where primary_topic in ["mental_health", "psychology", "neuroscience"]}}
            - {{digest_headline}} â†’ {{digest_takeaway}}
            {{/each}}

            Todayâ€™s AI highlights:
            {{#each items where primary_topic in ["ai_research", "ai_product"]}}
            - {{digest_headline}} â†’ {{digest_takeaway}}
            {{/each}}

            Write a 150â€“220 word closing that:
            - draws 1â€“2 big threads between the mind and the machine stories
            - offers a reflective, hopeful tone
            - ends with one concrete micro-action readers can take today.
            {{/llm}}

            ---
            _Generated by OpenClaw + a slightly obsessed AI-first founder._

      - id: publish_output
        type: output
        params:
          channels:
            - type: file
              path: "out/daily_mental_health_ai_digest_{{ now | date('YYYY-MM-DD') }}.md"

            - type: notion_database
              database_id: "{{ env.NOTION_DIGEST_DATABASE_ID }}"
              title: "Daily Brain & Machine Digest â€” {{ now | date('YYYY-MM-DD') }}"
              date_field: "Digest Date"
              date_value: "{{ now | date('YYYY-MM-DD') }}"
              content_field: "Content"
              content_template_field: "newsletter_markdown"

            - type: webhook
              url: "{{ env.NEWSLETTER_WEBHOOK_URL }}"
              method: POST
              body_field: "content"
              body_template_field: "newsletter_markdown"

notes:
  - "Exact step and parameter names may differ by OpenClaw build."
  - "Canonical sequence: fetch â†’ clean â†’ filter â†’ dedupe â†’ classify â†’ summarize â†’ commentary â†’ newsletter â†’ publish."
